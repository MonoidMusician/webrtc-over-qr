<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <base href="">
    <script class="stage1" src="stage1.js"></script>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="index.css" />
  </head>
  <body>
    <div id="main">
      <h1 id="title" style="font-size: 2rem">
        <svg id="favicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="#eee">
          <path d="M44.8 22.4a22.4 22.4 0 0 1-44.8 0V0h22.4a22.4 22.4 0 0 1 22.4 22.4Z" fill="#1d2443" />
          <path d="M64 41.6a22.4 22.4 0 1 1-22.4-22.4H64v22.4z" fill="#4f3362" />
          <path
            d="M16.11 13.42c0-.92.58-1.4 2.88-1.4 2.2 0 4.55.6 4.55 4.41 0 3.68-1.8 4.87-4.9 4.87-.8 0-2.11-.1-2.53-.32zm-2.75 3.84v7.84c0 2.4-.06 4.68-.32 6.4l.06.1a13.96 13.96 0 0 1 3.27 0l.06-.1c-.25-1.82-.32-4-.32-6.4v-2.75c.7.23 1.57.32 2.69.32 5.82 0 7.84-3.68 7.84-6.4 0-2.37-1.5-5.63-7.42-5.63-.84 0-3.52.22-4.48.22-.39 0-1.25-.03-1.64-.1l-.06.1c.26 1.83.32 4 .32 6.4z" aria-label="P" />
          <path
            d="M29.6 26.5c.89 0 1.87.98 1.87 2.5 0 1.56-.08 2.83-1.52 4.3l-1.81 1.78c-2.4 2.45-3.13 3.57-3.13 5.02l.02.1c2.38-.03 4.24-.1 6.1-.1 1.83 0 2.42.02 4.25.1a6.16 6.16 0 0 1 0-2.77c-1.42.1-2.1.22-4.55.22h-2c0-.4.88-1.61 1.39-2.1l2.44-2.37c1.4-1.35 2.6-2.3 2.6-4.16 0-2.64-2.55-3.84-5.46-3.84-1.76 0-3.93.8-4.55 1.34l-.07.1.52 1.93 1.07.03c.8-1.45 1.64-2.08 2.84-2.08z" aria-label="2" />
          <path
            d="M42.35 35.83c0-.93.57-1.4 2.88-1.4 2.2 0 4.54.6 4.54 4.4 0 3.69-1.8 4.87-4.9 4.87-.8 0-2.1-.1-2.52-.32zm-2.75 3.84v7.84c0 2.4-.07 4.67-.32 6.4l.06.1a13.96 13.96 0 0 1 3.26 0l.07-.1c-.26-1.82-.32-4-.32-6.4v-2.75c.7.22 1.57.32 2.69.32 5.82 0 7.84-3.68 7.84-6.4 0-2.37-1.5-5.63-7.43-5.63-.83 0-3.52.22-4.48.22-.38 0-1.25-.03-1.63-.1l-.06.1c.25 1.82.32 4 .32 6.4z" aria-label="P" />
        </svg>&thinsp;WebRTC over QR <span id="role_description"></span>
      </h1>

      <div id="site_content">
        <div id="introduction" style="text-align: left; line-height: 130%">
          <p>This is a project exploring how close we can get to a <em>truly</em> Peer-to-Peer WebRTC experience: just a single offline HTML file on the host, bootstrapped onto the guest via &lt;2,953 bytes of HTML squeezed into a single QR code (plus a return QR code is required for some browser engines). No servers in the middle, just two web browsers speaking WebRTC and JavaScript to each other.</p>

          <p>Please read the caveats below before trying it out! It is incredibly cool that it is even possible, and even somewhat portable between browsers (though Chromium works best), and I have done my best to smooth out the rough edges to make it pleasant to use. The concept underlying the connection procedure is relatively simple, and I have written a chat app on top to demonstrate its usefulness and test aspects like latency (try running /ping).</p>

          <p>More information and downloads at <a href="https://webrtc-over-qr.veritates.love/">https://webrtc-over-qr.veritates.love/</a>.</p>
        </div>
        <hr/>

        <h2>Try it!</h2>

        <ul>
          <li>You may run it online: <a href="/online/webrtc-over-qr.html">/online/webrtc-over-qr.html</a>.</li>
          <li>You may download it and use it offline: <a href="/download/webrtc-over-qr.html">/download/webrtc-over-qr.html</a> (a self-contained HTML file, actually the same file as the online version).</li>
        </ul>

        The instructions for using it with another device (e.g. hosting on a computer and joining as a guest with a phone) are on the page.
        You may also use it on its own, either in side-by-side mode or echo/loopback mode (both modes still go over WebRTC).

        <h2>Blog Posts</h2>

        <ul>
          <li><a href="https://blog.veritates.love/qrinqr.html">Code golf for computing a 32-byte QR code!</a>, explaining how I squeeze the QR code generator for the guest into the QR code for bootstrapping.</li>
          <li>Coming soon: explaining the connection protocol, how it uses <code>ice-ufrag</code>.</li>
        </ul>

        <h2>Code</h2>

        <p>The code repository is currently at <a href="https://github.com/MonoidMusician/webrtc-over-qr">MonoidMusician/webrtc-over-qr</a> on GitHub.</p>

        <p>The only dependency is the QR code library, which is <a href="https://github.com/zxing-js/library">ZXing-JS</a> (“Zebra Crossing”), and provides QR code generation and scanning on the host. My only modification to it was to remove features that I do not use and then re-bundle it, to reduce the size.</p>

        <hr/><br/>

        <details open id="caveats">
          <summary><h2 style="display: inline; cursor: pointer">Caveats</h2></summary>

          <ul>
            <li><p>WebRTC discovery works differently across browser engines. Chromium-based browsers give the nicest experience: we are able to auto-discover guests when they open the page and try to connect. On other engines (like Safari and Firefox), the certificate fingerprint generated by the guest must be sent back to the host via some other method (QR code, copy+paste, instant message, verbal transcription, etc.).</p> <p>Our mode of connection (entirely peer-to-peer) is somewhat unintended, as WebRTC was designed to have a (trusted!) signaling server mediate a connection. Thus there is no uniform experience we can offer, although we can try our best and add workarounds for these situations.</p></li>
            <li><p>Firefox behaves very differently based on the flag <code>media.peerconnection.ice.obfuscate_host_addresses</code> in <code>about:config</code> (which is set to <code>true</code> by default). In particular, it seems to impose a ~5 second timeout as guest. And as host, it will not connect to a Chromium guest? So you might want to set this to <code>false</code> while trying the demo, or use a different browser instead. Note that it is a global setting, so remember to set it back to the default <code>true</code> when you are done.</p></li>
            <li><p>While we produce standards-compliant QR codes, they aren’t exactly usable by existing software: the QR code generated by the host contains a data URI, which most phone apps will not recognize as a link, and even if they do, browsers will not open data URIs from external sources (or in the case of Firefox on iOS, ever at all), so you may have to install a 3rd party QR code scanner and copy and paste the URL into a browser. And on the flip side, the QR code generated by the guest is 32 bytes of raw binary data, which most scanners will not even display for you, and would not be safe to copy as text. However, this is less of an issue since we can embed a QR scanner here in secure contexts (HTTPS, localhost, and apparently local files too).</p></li>
            <li><p>A lot of nice web APIs understandably do not work in insecure contexts. The goal of bootstrapping a peer-to-peer web chat over QR is not secure, so there is not much we can do about it. This means no access to webcams or microphones, no popup notifications, etc., at least from the guest. But there is still a lot of amazing things that we can do, things that any (web) chat app could have done but didn’t.</p></li>
            <li><p>The demo has no way of reestablishing a connection if it drops (I do not know if it would be technically possible at all without manually passing information between the peers again ... you could at least pre-establish the certificates to use). The demo also does not use STUN or TURN servers, which facilitate connections behind NAT/firewalls, so it may only work between devices on your local network. <!-- This is a lie and you can add stun servers using query parameters like `?stun=stun:stun1.example.com:3478&stun=sun:stun2.example.com:3478`. --></p></li>
          </ul>
        </details>
      </div>
    </div>
  </body>
</html>